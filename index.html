<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Sentiment & Noun Analyzer</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; }
        input, button { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        .review-box { background: white; padding: 15px; border: 1px solid #ddd; margin: 10px 0; }
        .result { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 5px; }
        .noun-highlight { background-color: yellow; font-weight: bold; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .loading { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Review Sentiment & Noun Analyzer</h1>
        
        <!-- Hugging Face API Setup -->
        <div class="api-setup">
            <h3>Hugging Face API Setup</h3>
            <input type="password" id="apiToken" placeholder="Enter your Hugging Face API Token" style="width: 300px;">
            <p><small>Your token is stored only in your browser and is never sent to our servers.</small></p>
            <p class="warning"><strong>Note:</strong> You need a valid Hugging Face token. Get one at <a href="https://huggingface.co/settings/tokens" target="_blank">huggingface.co/settings/tokens</a></p>
        </div>

        <!-- Analysis Controls -->
        <div class="controls">
            <button onclick="loadRandomReview()">Load Random Review</button>
            <button onclick="analyzeSentiment()">Analyze Sentiment</button>
            <button onclick="countNouns()">Count Nouns</button>
        </div>

        <!-- Display Areas -->
        <div class="review-box">
            <h3>Selected Review:</h3>
            <div id="reviewText">Click "Load Random Review" to load a review.</div>
        </div>

        <div class="result">
            <h3>Analysis Results:</h3>
            <div id="sentimentResult">Sentiment will appear here</div>
            <div id="nounResult">Noun analysis will appear here</div>
        </div>
    </div>

    <script>
        let currentReview = '';
        
        // Тестовые отзывы
        const testReviews = [
            "The product quality is excellent but the delivery service was terrible.",
            "I love lemon grass tea! I love this soup! Going to double my order.",
            "McVitie's digestive biscuits are great - not nearly as sweet as competitors.",
            "This is the best purchase I've made all year. Outstanding quality!",
            "Disappointed with the product. It broke after first use."
        ];

        // Список распространенных существительных
        const commonNouns = new Set([
            'product', 'quality', 'delivery', 'service', 'tea', 'soup', 'order',
            'biscuits', 'competitors', 'problem', 'packaging', 'purchase', 'year',
            'customer', 'support', 'item', 'price', 'shipping', 'box', 'package',
            'company', 'brand', 'taste', 'flavor', 'size', 'color', 'material',
            'design', 'feature', 'benefit', 'advantage', 'disadvantage', 'issue'
        ]);

        // Загружаем случайный отзыв
        function loadRandomReview() {
            const randomIndex = Math.floor(Math.random() * testReviews.length);
            currentReview = testReviews[randomIndex];
            document.getElementById('reviewText').textContent = currentReview;
            document.getElementById('sentimentResult').textContent = 'Sentiment will appear here';
            document.getElementById('nounResult').textContent = 'Noun analysis will appear here';
            // Сбрасываем классы
            document.getElementById('sentimentResult').className = '';
            document.getElementById('nounResult').className = '';
        }

        // Анализ тональности - ИСПРАВЛЕННАЯ ВЕРСИЯ
        async function analyzeSentiment() {
            const apiToken = document.getElementById('apiToken').value.trim();
            if (!apiToken) {
                alert('Please enter your Hugging Face API Token');
                return;
            }

            if (!currentReview) {
                alert('Please load a review first');
                return;
            }

            const resultEl = document.getElementById('sentimentResult');
            resultEl.textContent = 'Analyzing sentiment...';
            resultEl.className = 'loading';

            try {
                // Используем надежную модель, которая точно работает
                const response = await fetch(
                    "https://api-inference.huggingface.co/models/distilbert-base-uncased-finetuned-sst-2-english",
                    {
                        headers: { 
                            Authorization: `Bearer ${apiToken}`,
                            "Content-Type": "application/json"
                        },
                        method: "POST",
                        body: JSON.stringify({ inputs: currentReview }),
                    }
                );
                
                if (response.status === 401) {
                    throw new Error('Invalid API token. Please check your Hugging Face token.');
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('API Response:', result);

                // Обрабатываем результат для модели distilbert
                if (Array.isArray(result) && result.length > 0) {
                    const sentimentArray = result[0];
                    
                    if (Array.isArray(sentimentArray)) {
                        // Формат: [{"label": "POSITIVE", "score": 0.998}, {"label": "NEGATIVE", "score": 0.002}]
                        let positiveScore = 0;
                        let negativeScore = 0;
                        
                        sentimentArray.forEach(item => {
                            if (item.label === 'POSITIVE' || item.label === 'LABEL_1') {
                                positiveScore = item.score;
                            } else if (item.label === 'NEGATIVE' || item.label === 'LABEL_0') {
                                negativeScore = item.score;
                            }
                        });
                        
                        const finalLabel = positiveScore > negativeScore ? 'POSITIVE' : 'NEGATIVE';
                        const finalScore = finalLabel === 'POSITIVE' ? positiveScore : negativeScore;
                        
                        resultEl.innerHTML = 
                            `<strong>Sentiment:</strong> ${finalLabel} <br>
                             <strong>Confidence:</strong> ${(finalScore * 100).toFixed(2)}% <br>
                             <strong>Details:</strong> Positive: ${(positiveScore * 100).toFixed(2)}%, Negative: ${(negativeScore * 100).toFixed(2)}% <br>
                             <strong>Model:</strong> distilbert-base-uncased-finetuned-sst-2-english`;
                        resultEl.className = 'success';
                    } else {
                        // Если формат другой, покажем сырой ответ для отладки
                        resultEl.innerHTML = 
                            `<strong>Unexpected format:</strong> ${JSON.stringify(result)} <br>
                             <small>Please try another review</small>`;
                        resultEl.className = 'warning';
                    }
                } else if (result.error) {
                    // Если модель загружается
                    if (result.error.includes('loading')) {
                        resultEl.innerHTML = 
                            'Model is loading... Please wait 10-20 seconds and try again. <br>' +
                            '<small>This happens when the model hasn\'t been used recently</small>';
                        resultEl.className = 'loading';
                    } else {
                        throw new Error(result.error);
                    }
                } else {
                    throw new Error('Unexpected response format');
                }

            } catch (error) {
                console.error('Sentiment analysis error:', error);
                resultEl.innerHTML = 
                    `<strong>Error:</strong> ${error.message} <br>
                     <small>Try using a different model or check your token permissions</small>`;
                resultEl.className = 'error';
            }
        }

        // Подсчет существительных
        function countNouns() {
            if (!currentReview) {
                alert('Please load a review first');
                return;
            }

            const resultEl = document.getElementById('nounResult');
            resultEl.textContent = 'Counting nouns...';
            resultEl.className = 'loading';

            try {
                // Разбиваем текст на слова
                const words = currentReview.toLowerCase()
                    .replace(/[^a-z\s]/g, ' ')
                    .split(/\s+/)
                    .filter(word => word.length > 2);

                // Ищем существительные
                const foundNouns = words.filter(word => commonNouns.has(word));
                const uniqueNouns = [...new Set(foundNouns)];

                // Подсвечиваем найденные существительные
                let highlightedText = currentReview;
                uniqueNouns.forEach(noun => {
                    const regex = new RegExp(`\\b${noun}\\b`, 'gi');
                    highlightedText = highlightedText.replace(regex, `<span class="noun-highlight">${noun}</span>`);
                });

                document.getElementById('reviewText').innerHTML = highlightedText;
                
                if (uniqueNouns.length > 0) {
                    resultEl.innerHTML = 
                        `<strong>Nouns Found:</strong> ${uniqueNouns.length} <br>
                         <strong>Nouns List:</strong> ${uniqueNouns.join(', ')} <br>
                         <small>Nouns are highlighted in yellow</small>`;
                    resultEl.className = 'success';
                } else {
                    resultEl.innerHTML = 
                        `<strong>No common nouns detected</strong> <br>
                         <small>Using simple pattern matching. Try: "product", "quality", "delivery", etc.</small>`;
                    resultEl.className = 'warning';
                }

            } catch (error) {
                console.error('Noun counting error:', error);
                resultEl.textContent = `Error: ${error.message}`;
                resultEl.className = 'error';
            }
        }

        // Инициализация
        window.onload = function() {
            loadRandomReview(); // Автоматически загружаем первый отзыв
        };
    </script>
</body>
</html>
